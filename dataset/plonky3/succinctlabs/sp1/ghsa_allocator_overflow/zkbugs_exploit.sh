#!/bin/bash
# Run unit tests to demonstrate the vulnerability

set -e

echo "=========================================="
echo "Running Unit Tests"
echo "=========================================="
echo ""

TESTS_DIR="tests"
OUTPUT_BINARY="$TESTS_DIR/unit_tests"

if [ ! -f "$OUTPUT_BINARY" ]; then
    echo "❌ Unit test binary not found: $OUTPUT_BINARY"
    echo "   Run ./zkbugs_compile_setup.sh first"
    exit 1
fi

echo "Executing tests..."
"$OUTPUT_BINARY" --test-threads=1 2>&1 | tee "$TESTS_DIR/test_output.log"

TEST_STATUS=${PIPESTATUS[0]}

echo ""
if [ $TEST_STATUS -eq 0 ]; then
    echo "✓ All tests passed!"
else
    echo "❌ Some tests failed (exit code: $TEST_STATUS)"
fi

echo ""
exit $TEST_STATUS
